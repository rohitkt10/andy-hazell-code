Misc code and latex by Andy Hazell